name: Deploy Backend to VPS

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - "backend/**"
      - ".github/workflows/deploy-backend.yml"

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: northernchile-backend
  VPS_HOST: api.northernchile.com
  VPS_USER: root
  APP_DIR: /app/northernchile

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      image: ${{ steps.meta.outputs.tags }}
      image_name: ${{ steps.image.outputs.full_name }}

    steps:
      - uses: actions/checkout@v4

      - name: Generate image name
        id: image
        run: |
          FULL_NAME="${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}"
          echo "full_name=${FULL_NAME,,}" >> $GITHUB_OUTPUT

      - uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: |
            ${{ steps.image.outputs.full_name }}:latest
            ${{ steps.image.outputs.full_name }}:${{ github.sha }}
          cache-from: type=registry,ref=${{ steps.image.outputs.full_name }}:buildcache
          cache-to: type=registry,ref=${{ steps.image.outputs.full_name }}:buildcache,mode=max

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_PRIVATE_KEY }}" > ~/.ssh/key
          chmod 600 ~/.ssh/key
          ssh-keyscan -H ${{ env.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Create .env file
        run: |
          cat > .env << EOF
          # Database
          SPRING_DATASOURCE_URL=${{ secrets.SPRING_DATASOURCE_URL }}
          SPRING_DATASOURCE_USERNAME=${{ secrets.SPRING_DATASOURCE_USERNAME }}
          SPRING_DATASOURCE_PASSWORD=${{ secrets.SPRING_DATASOURCE_PASSWORD }}

          # Security
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          SPRING_REMOTE_SECRET=${{ secrets.SPRING_REMOTE_SECRET }}

          # Admin
          ADMIN_USERS_CONFIG=${{ secrets.ADMIN_USERS_CONFIG }}

          # AWS
          AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION=${{ secrets.AWS_REGION }}
          AWS_S3_BUCKET_NAME=${{ secrets.AWS_S3_BUCKET_NAME }}

          # External APIs
          WEATHER_API_KEY=${{ secrets.WEATHER_API_KEY }}
          GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}

          # URLs
          NUXT_PUBLIC_BASE_URL=https://www.northernchile.com
          APP_BASE_URL=https://${{ env.VPS_HOST }}

          # Email
          MAIL_ENABLED=${{ secrets.MAIL_ENABLED }}
          MAIL_FROM_EMAIL=${{ secrets.MAIL_FROM_EMAIL }}
          MAIL_FROM_NAME=${{ secrets.MAIL_FROM_NAME }}
          NOTIFICATION_ADMIN_EMAIL=${{ secrets.NOTIFICATION_ADMIN_EMAIL }}

          # Payments
          PAYMENT_TEST_MODE=${{ secrets.PAYMENT_TEST_MODE }}
          TRANSBANK_COMMERCE_CODE=${{ secrets.TRANSBANK_COMMERCE_CODE }}
          TRANSBANK_API_KEY=${{ secrets.TRANSBANK_API_KEY }}
          TRANSBANK_ENVIRONMENT=${{ secrets.TRANSBANK_ENVIRONMENT }}
          MERCADOPAGO_ACCESS_TOKEN=${{ secrets.MERCADOPAGO_ACCESS_TOKEN }}
          MERCADOPAGO_PUBLIC_KEY=${{ secrets.MERCADOPAGO_PUBLIC_KEY }}
          MERCADOPAGO_WEBHOOK_SECRET=${{ secrets.MERCADOPAGO_WEBHOOK_SECRET }}

          # Security
          ALLOWED_REDIRECT_DOMAINS=https://www.northernchile.com,https://northernchile.com
          SEED_DATA=false
          EOF

      - name: Create docker-compose.prod.yml
        run: |
          cat > docker-compose.prod.yml << EOF
          services:
            backend:
              image: ${{ needs.build.outputs.image_name }}:latest
              restart: always
              ports:
                - "127.0.0.1:8080:8080"
              env_file:
                - .env
              environment:
                - SPRING_PROFILES_ACTIVE=prod
              volumes:
                - ./logs:/app/logs
              logging:
                driver: json-file
                options:
                  max-size: "10m"
                  max-file: "3"
          EOF

      - name: Deploy to VPS
        env:
          SSH_CMD: ssh -i ~/.ssh/key -o StrictHostKeyChecking=no -o ConnectTimeout=30 ${{ env.VPS_USER }}@${{ env.VPS_HOST }}
          SCP_CMD: scp -i ~/.ssh/key -o StrictHostKeyChecking=no -o ConnectTimeout=30
        run: |
          # Create directories
          $SSH_CMD "mkdir -p ${{ env.APP_DIR }}/logs"

          # Copy files
          $SCP_CMD .env ${{ env.VPS_USER }}@${{ env.VPS_HOST }}:${{ env.APP_DIR }}/
          $SCP_CMD docker-compose.prod.yml ${{ env.VPS_USER }}@${{ env.VPS_HOST }}:${{ env.APP_DIR }}/

          # Deploy
          $SSH_CMD << 'DEPLOY'
            cd ${{ env.APP_DIR }}
            echo "${{ secrets.GHCR_PAT }}" | docker login ghcr.io -u "${{ github.repository_owner }}" --password-stdin
            docker compose -f docker-compose.prod.yml pull
            docker compose -f docker-compose.prod.yml up -d --remove-orphans
            docker image prune -f
          DEPLOY

      - name: Health check
        run: |
          echo "Waiting for app to start..."
          for i in {1..30}; do
            if ssh -i ~/.ssh/key ${{ env.VPS_USER }}@${{ env.VPS_HOST }} \
               "curl -sf http://localhost:8080/actuator/health" > /dev/null 2>&1; then
              echo "✅ Healthy!"
              exit 0
            fi
            echo "Attempt $i/30..."
            sleep 5
          done
          echo "❌ Failed to start"
          ssh -i ~/.ssh/key ${{ env.VPS_USER }}@${{ env.VPS_HOST }} \
            "docker logs \$(docker ps -aq --filter name=backend) --tail 100"
          exit 1

      - name: Show status
        if: always()
        run: |
          ssh -i ~/.ssh/key ${{ env.VPS_USER }}@${{ env.VPS_HOST }} \
            "docker ps -a && docker logs \$(docker ps -aq --filter name=backend) --tail 30" \
            || echo "Could not connect"
