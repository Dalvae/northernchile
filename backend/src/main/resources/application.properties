spring.jpa.open-in-view=false
spring.application.name=backend-api

# Internationalization (i18n)
spring.messages.basename=messages
spring.messages.encoding=UTF-8
spring.messages.fallback-to-system-locale=false

# Conexión a la Base de Datos (leída desde .env)
spring.datasource.url=${SPRING_DATASOURCE_URL}
spring.datasource.username=${SPRING_DATASOURCE_USERNAME}
spring.datasource.password=${SPRING_DATASOURCE_PASSWORD}

# HikariCP Connection Pool Configuration (optimized for Neon serverless with pgBouncer)
# Aggressive settings to allow Neon to auto-suspend when idle
# This minimizes compute hours on Neon's free tier (100 CU-hrs/month)
# When using pgBouncer (-pooler endpoint), use minimal pool size since pgBouncer handles pooling
spring.datasource.hikari.minimum-idle=0
spring.datasource.hikari.maximum-pool-size=2
spring.datasource.hikari.idle-timeout=60000
spring.datasource.hikari.max-lifetime=1800000
spring.datasource.hikari.connection-timeout=20000
spring.datasource.hikari.keepalive-time=0



# Configuración de Flyway (para migraciones de BD)
# Flyway enabled for versioned database migrations
# Hibernate validates schema against entities (no auto-creation or updates)
spring.jpa.hibernate.ddl-auto=validate
spring.flyway.enabled=true
spring.flyway.baseline-on-migrate=true
spring.flyway.locations=classpath:db/migration
# Authentication Configuration (centralized via AuthProperties)
auth.jwt.secret=${JWT_SECRET:change-me-in-prod}
auth.jwt.expiration=86400000
auth.token.verification.expiration-hours=24
auth.token.password-reset.expiration-hours=2

# Application Configuration (centralized via AppProperties)
app.frontend-base-url=${NUXT_PUBLIC_BASE_URL:http://localhost:3000}
app.tax-rate=0.19
app.booking.min-hours-before-tour=2
app.manifest.operator-email=${NOTIFICATION_ADMIN_EMAIL:contacto@northernchile.com}
app.manifest.emergency-contact=+56 9 5765 5764
app.cookie.domain=${COOKIE_DOMAIN:}
app.cookie.insecure=${COOKIE_INSECURE:false}
app.security.allowed-redirect-domains=${ALLOWED_REDIRECT_DOMAINS:http://localhost:3000,https://www.northernchile.com,https://northernchile.com}

# Jackson configuration for proper BigDecimal serialization
# Ensures BigDecimal values are sent as plain strings in JSON (not scientific notation)
# This prevents floating-point precision issues on the frontend
spring.jackson.generator.write-bigdecimal-as-plain=true

# Initial Admin User Credentials (DEPRECATED - use admin.users.config instead)
# These credentials will be used to create the first Super Admin if none exists
# NOTA: Estas variables están obsoletas, pero se mantienen por compatibilidad
admin.email=${ADMIN_EMAIL:admin@northernchile.com}
admin.fullName=${ADMIN_FULL_NAME:Admin Principal}
admin.password=${ADMIN_PASSWORD:change-me-in-prod}

# Multi-Admin Users Configuration (NEW - Recommended)
# Format: email:password:role;email2:password2:role2;...
# Example: alex@example.com:pass123:ROLE_SUPER_ADMIN;diego@example.com:pass456:ROLE_PARTNER_ADMIN
# Roles: ROLE_SUPER_ADMIN, ROLE_PARTNER_ADMIN, ROLE_CLIENT
admin.users.config=${ADMIN_USERS_CONFIG:}

# Data Seeding Configuration
# Set to 'true' to populate database with synthetic tour data on startup
# This is useful for development, demos, and MVP presentations
# WARNING: Only seeds data if the database is empty (no tours exist)
seed.data=${SEED_DATA:false}



# Logging Configuration
# Log levels: TRACE, DEBUG, INFO, WARN, ERROR
logging.level.root=INFO
logging.level.com.northernchile=INFO
logging.level.org.springframework.web=INFO
logging.level.org.hibernate.SQL=WARN
logging.level.org.hibernate.type.descriptor.sql.BasicBinder=WARN

# Log pattern for console output (includes colors)
logging.pattern.console=%clr(%d{yyyy-MM-dd HH:mm:ss.SSS}){faint} %clr(%5p) %clr(${PID:- }){magenta} %clr(---){faint} %clr([%15.15t]){faint} %clr(%-40.40logger{39}){cyan} %clr(:){faint} %m%n%wEx

# Log file configuration
logging.file.name=logs/application.log
logging.file.max-size=10MB
logging.file.max-history=30
logging.file.total-size-cap=1GB
logging.pattern.file=%d{yyyy-MM-dd HH:mm:ss.SSS} %5p ${PID:- } --- [%t] %-40.40logger{39} : %m%n%wEx

# Log de SQL generado por Hibernate (útil en dev)
spring.jpa.show-sql=false
spring.jpa.properties.hibernate.format_sql=false

# Puerto del servidor
server.port=8080

# Base URL for the application (used for webhooks, email links, etc.)
# In production, this should be the public URL of the server
app.base-url=${APP_BASE_URL:http://localhost:8080}

# Increase max HTTP header size (default is 8KB, increase to 32KB)
# This prevents "Request header is too large" errors with large cookies/JWT
server.max-http-request-header-size=32KB
spring.devtools.remote.restart.enabled=true
spring.devtools.remote.secret=${SPRING_REMOTE_SECRET:change-me-in-dev}

# Timezone Configuration
# Application timezone for Chile (handles DST automatically)
# UTC-04:00 in winter (April-September) and UTC-03:00 in summer (September-April)
app.timezone=America/Santiago

# Jackson Configuration for Timezone
# Send dates to frontend in Chile timezone with proper offset
spring.jackson.time-zone=America/Santiago
spring.jackson.serialization.write-dates-as-timestamps=false

# Hibernate/JPA Timezone Configuration
# Store all timestamps as UTC in the database (no conversion)
# This is critical when using TIMESTAMP (without timezone) columns
spring.jpa.properties.hibernate.jdbc.time_zone=UTC
# Configuración de OpenAPI (Swagger)
springdoc.swagger-ui.path=/swagger-ui.html
springdoc.api-docs.path=/api-docs
springdoc.show-actuator=true
springdoc.version=v0.0.1
springdoc.info.title=Northern Chile API
springdoc.info.description=API RESTful para la plataforma de tours Northern Chile.

# OpenWeatherMap 5 Day / 3 Hour Forecast API (Free Plan)
# Obtén tu API key en: https://home.openweathermap.org/api_keys
# Free tier: 60 calls/min, 1M calls/month, 5 days forecast
weather.api.key=${WEATHER_API_KEY:dummy}
weather.api.lat=-22.9083
weather.api.lon=-68.1999

# AWS S3 Configuration for Assets Storage
aws.accessKeyId=${AWS_ACCESS_KEY_ID}
aws.secretAccessKey=${AWS_SECRET_ACCESS_KEY}
aws.region=${AWS_REGION:sa-east-1}
aws.s3.bucketName=${AWS_S3_BUCKET_NAME:northern-chile-assets}

# File Upload Configuration
spring.servlet.multipart.max-file-size=10MB
spring.servlet.multipart.max-request-size=10MB

# Spring Boot Actuator Configuration
# Enable health endpoint (liveness and readiness probes for Kubernetes/Docker)
management.endpoints.web.exposure.include=health,info
management.endpoint.health.show-details=when-authorized
management.endpoint.health.probes.enabled=true
management.health.livenessstate.enabled=true
management.health.readinessstate.enabled=true
# Disable mail health check (no longer using SMTP)
management.health.mail.enabled=false
# Disable DB health check to prevent Neon compute usage when idle (connection pool stays active)
management.health.db.enabled=false
# Base path for actuator endpoints
management.endpoints.web.base-path=/actuator

# Email Configuration (Amazon SES via HTTP API)
# Uses AWS SDK instead of SMTP to bypass port 465/587 blocks on DigitalOcean
# Credentials can be shared with S3 or use dedicated SES credentials
aws.ses.access-key-id=${AWS_ACCESS_KEY_ID:}
aws.ses.secret-access-key=${AWS_SECRET_ACCESS_KEY:}
aws.ses.region=${AWS_SES_REGION:${AWS_REGION:us-east-1}}

# Email Configuration (centralized via MailProperties)
mail.enabled=${MAIL_ENABLED:false}
mail.from.email=${MAIL_FROM_EMAIL:noreply@northernchile.com}
mail.from.name=${MAIL_FROM_NAME:Northern Chile Tours}
mail.reminder.hours-before-tour=24

# Admin notification email (receives booking alerts, contact forms, etc.)
notification.admin.email=${NOTIFICATION_ADMIN_EMAIL:contacto@northernchile.com}

# Payment Configuration (centralized via PaymentProperties)
payment.test-mode=${PAYMENT_TEST_MODE:false}

# Transbank (Webpay Plus - Chile)
# Environment: INTEGRATION or PRODUCTION
# For testing, use integration credentials (default values)
# For production, request credentials from Transbank at https://www.transbankdevelopers.cl
payment.transbank.commerce-code=${TRANSBANK_COMMERCE_CODE:597055555532}
payment.transbank.api-key=${TRANSBANK_API_KEY:579B532A7440BB0C9079DED94D31EA1615BACEB56610332264630D42D0A36B1C}
payment.transbank.environment=${TRANSBANK_ENVIRONMENT:INTEGRATION}
payment.transbank.webhook-secret=${TRANSBANK_WEBHOOK_SECRET:}
# Transbank Estimated Fee Rates (for financial reconciliation)
# VD (Debit): ~1.49% + IVA = 1.77%, VN/VC (Credit): ~2.95% + IVA = 3.51%
payment.transbank.fees.debit=${TRANSBANK_FEE_DEBIT:0.0177}
payment.transbank.fees.credit=${TRANSBANK_FEE_CREDIT:0.0351}
payment.transbank.fees.prepaid=${TRANSBANK_FEE_PREPAID:0.0177}

# Mercado Pago (Latin America, PIX - Brazil)
# Get credentials at: https://www.mercadopago.com/developers/panel
payment.mercadopago.access-token=${MERCADOPAGO_ACCESS_TOKEN:TEST-ACCESS-TOKEN}
payment.mercadopago.webhook-secret=${MERCADOPAGO_WEBHOOK_SECRET:}

# Refund Retention - percentage retained to cover payment processing fees
payment.refund.retention-percentage=${REFUND_RETENTION_PERCENTAGE:5}

# ============================================
# Resilience4j Circuit Breaker Configuration
# ============================================
# Circuit breakers protect against cascading failures when external services are down

# Weather API Circuit Breaker
# Opens after 50% failures in 10 request window, stays open 30s before half-open
resilience4j.circuitbreaker.instances.weather.sliding-window-type=COUNT_BASED
resilience4j.circuitbreaker.instances.weather.sliding-window-size=10
resilience4j.circuitbreaker.instances.weather.failure-rate-threshold=50
resilience4j.circuitbreaker.instances.weather.wait-duration-in-open-state=30s
resilience4j.circuitbreaker.instances.weather.permitted-number-of-calls-in-half-open-state=3
resilience4j.circuitbreaker.instances.weather.slow-call-duration-threshold=5s
resilience4j.circuitbreaker.instances.weather.slow-call-rate-threshold=80

# Payment Provider Circuit Breaker (for Transbank, MercadoPago)
# More conservative - opens after 50% failures in 5 requests, stays open 60s
resilience4j.circuitbreaker.instances.payment.sliding-window-type=COUNT_BASED
resilience4j.circuitbreaker.instances.payment.sliding-window-size=5
resilience4j.circuitbreaker.instances.payment.failure-rate-threshold=50
resilience4j.circuitbreaker.instances.payment.wait-duration-in-open-state=60s
resilience4j.circuitbreaker.instances.payment.permitted-number-of-calls-in-half-open-state=2
